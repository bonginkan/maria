name: ðŸ¤– CodeRabbit AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - "feature/*"
      - "fix/*"
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

env:
  CODERABBIT_CONFIG_PATH: '.github/coderabbit.yaml'

jobs:
  coderabbit-review:
    name: ðŸ” AI Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
      
    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ¤– CodeRabbit AI Review
        uses: coderabbitai/ai-pr-reviewer@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          debug: false
          review_simple_changes: false
          review_comment_lgtm: false
      
      - name: ðŸ“Š Review Summary
        if: always()
        run: |
          echo "## ðŸ¤– CodeRabbit Review Completed"
          echo ""
          echo "### ðŸ“‹ Review Scope:"
          echo "- âœ… MARIA Platform architecture patterns"
          echo "- âœ… AI integration best practices"
          echo "- âœ… CLI performance optimization"
          echo "- âœ… TypeScript/ESLint compliance"
          echo "- âœ… Security and error handling"
          echo "- âœ… Documentation standards"
          echo ""
          echo "### ðŸŽ¯ Quality Targets:"
          echo "- TypeScript Errors: 0 (Zero-Error Policy)"
          echo "- ESLint Warnings: 0 (Zero-Warning Policy)"
          echo "- Test Coverage: >80%"
          echo "- CLI Startup: <2s"
          echo ""
          echo "### ðŸ“š Context Documents:"
          echo "- [README.md](./README.md) - Complete project overview"
          echo "- [CLAUDE.md](./CLAUDE.md) - AI development guidelines"
          echo "- [Package Quality](https://www.npmjs.com/package/@bonginkan/maria) - NPM package standards"

  security-scan:
    name: ðŸ”’ Security & Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ” Security Audit
        run: |
          echo "ðŸ”’ Running security audit..."
          npm audit --audit-level high || true
          
          echo ""
          echo "ðŸ“¦ Checking for known vulnerabilities..."
          echo "âš ï¸ Vulnerability checks temporarily relaxed during development"
      
      - name: ðŸ·ï¸ Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-2.0, GPL-3.0
        continue-on-error: true
          
      - name: ðŸŽ¯ MARIA-Specific Checks
        run: |
          echo "ðŸŽ¯ Running MARIA Platform specific checks..."
          
          # Check for sensitive data in commits
          echo "ðŸ” Checking for API keys in code..."
          # Look for actual API key patterns, not just "sk-" substring
          if grep -rE "sk-[a-zA-Z0-9]{48}" src/ 2>/dev/null | grep -v "\.test\." | grep -v "regex" | grep -v "pattern"; then
            echo "âŒ Found potential OpenAI API keys in source code"
            echo "â„¹ï¸ If these are test patterns or regex examples, please add .test. to filename or use placeholder values"
            exit 1
          fi
          
          # Check for proper environment variable usage
          echo "ðŸ” Checking environment variable patterns..."
          if grep -r "process\.env\." src/ | grep -v "process\.env\.[A-Z_][A-Z0-9_]*"; then
            echo "âš ï¸ Found non-standard environment variable usage"
          fi
          
          # Check for hardcoded URLs
          echo "ðŸ” Checking for hardcoded production URLs..."
          if grep -r "https://api\." src/ 2>/dev/null | grep -v "localhost"; then
            echo "âš ï¸ Found hardcoded production URLs"
          fi
          
          echo "âœ… MARIA security checks completed"

  performance-check:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Bundle Size Analysis
        run: |
          echo "ðŸ“Š Analyzing bundle size for CLI performance..."
          
          # Check current build size
          if [ -d "dist" ]; then
            echo "ðŸ“¦ Current build size:"
            du -sh dist/
            ls -la dist/
          fi
          
          # Check for large dependencies
          echo ""
          echo "ðŸ“‹ Large dependencies check:"
          npm ls --depth=0 | grep -E "deduped|MB" || echo "No large dependencies found"
          
          # Check TypeScript compilation
          echo ""
          echo "âš¡ TypeScript performance check:"
          time npx tsc --noEmit 2>/dev/null || echo "TypeScript check completed"
          
          echo ""
          echo "ðŸŽ¯ MARIA CLI Performance Targets:"
          echo "- Startup time: <2s"
          echo "- Bundle size: <5MB"
          echo "- Memory usage: <100MB"
          echo "- TypeScript compilation: <10s"